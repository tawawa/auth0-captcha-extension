module.exports=function(e){function t(o){if(n[o])return n[o].exports;var r=n[o]={exports:{},id:o,loaded:!1};return e[o].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}var r=n(14),a=o(r),i=n(8),s=o(i);e.exports=a.default.fromExpress(s.default)},function(e,t){e.exports=require("boom")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("request")},function(e,t,n){var o,r,a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(a,i,s){"undefined"!=typeof e&&e.exports?e.exports=s():(o=s,r="function"==typeof o?o.call(t,n,t,e):o,!(void 0!==r&&(e.exports=r)))}("urljoin",void 0,function(){function e(e,t){return e=e.replace(/:\//g,"://"),e=e.replace(/([^:\s])\/+/g,"$1/"),e=e.replace(/\/(\?|&|#[^!])/g,"$1"),e=e.replace(/(\?.+)\?/g,"$1&")}return function(){var t=arguments,n={};"object"===a(arguments[0])&&(t=arguments[0],n=arguments[1]||{});var o=[].slice.call(t,0).join("/");return e(o,n)}})},function(e,t){e.exports=require("body-parser")},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function r(e){return function(t,n,o){if(t.headers.authorization&&"Bearer"===t.headers.authorization.split(" ")[0]){var r=t.headers.authorization.split(" ")[1],a=y.default.verify(r,t.webtaskContext.data.EXTENSION_SECRET,{audience:(0,g.default)(t.webtaskContext.data.WT_URL,e),issuer:"https://"+t.webtaskContext.data.AUTH0_DOMAIN});return a?o():n.sendStatus(401)}return n.sendStatus(401)}}function a(e,t){var n=e.webtaskContext.data,o=n.AUTH0_DOMAIN,r="https://"+o+"/oauth/token",a="https://"+o+"/api/v2/",i=n.AUTH0_CLIENT_SECRET,s=n.AUTH0_CLIENT_ID;return new Promise(function(e,t){c.default.post(r,{body:{audience:a,grant_type:"client_credentials",client_id:s,client_secret:i},json:!0}).end(function(e,t,n){return e?reject(e):void resolve(n.access_token)})})}Object.defineProperty(t,"__esModule",{value:!0});var i=n(2),s=o(i),u=n(4),c=o(u),l=n(18),d=o(l),f=n(26),p=o(f),h=n(3),y=o(h),m=n(5),g=o(m),v=n(!function(){var e=new Error('Cannot find module "../hooks/captcha-rule.js"');throw e.code="MODULE_NOT_FOUND",e}()),b=o(v),x=d.default.ManagementClient,_=s.default.Router();t.default=_,_.use("/on-install",r("/.extensions/on-install")),_.use("/on-uninstall",r("/.extensions/on-uninstall")),_.use("/on-update",r("/.extensions/on-update")),_.use(function(e,t,n){a(e).then(function(t){var o=new x({domain:e.webtaskContext.data.AUTH0_DOMAIN,token:t});e.auth0=o,n()}).catch(n)}),_.post("/on-install",function(e,t){var n=e.webtaskContext.data;e.auth0.rules.create({name:"captcha-rule-PLEASE-DO-NOT-RENAME",script:(0,b.default)({MAX_ALLOWED_FAILED_ATTEMPTS:n.MAX_ALLOWED_FAILED_ATTEMPTS}),order:2,enabled:!0,stage:"login_success"}).then(function(){t.sendStatus(204)}).catch(function(){t.sendStatus(500)})}),_.put("/on-update",function(e,t){t.sendStatus(204)}),_.delete("/on-uninstall",function(e,t){e.auth0.rules.getAll().then(function(n){var o=p.default.find(n,{name:"captcha-rule-PLEASE-DO-NOT-RENAME"});o&&e.auth0.rules.delete({id:o.id}).then(function(){t.sendStatus(204)}).catch(function(){t.sendStatus(500)})}).catch(function(){t.sendStatus(500)})})},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),a=o(r),i=n(13),s=(o(i),n(11)),u=(o(s),n(15)),c=o(u),l=(0,a.default)();l.use("/.extensions",n(7)),l.use(c.default),t.default=l},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function r(e,t,n,o,r){return new Promise(function(o,r){var a={captchaOk:null===e,sub:n,errorMessage:e},s={expiresInMinutes:2,audience:getRuleUri(req),issuer:getWtUri(req)};i.default.sign(a,t,s,function(e,t){return e?r(e):void o(t)})})}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;var a=n(3),i=o(a)},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function r(e,t,n){return new Promise(function(o,r){function a(e,t,n){e&&reject(e),200!==t.statusCode&&reject("Error validating captcha: "+t.statusCode);var o=JSON.parse(n);o.success?r(!0):reject("Error from reCaptcha: "+JSON.stringify(o))}o.post({url:"https://www.google.com/recaptcha/api/siteverify",form:{response:e,secret:t,remoteip:n}},a)})}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;var a=n(4);o(a)},function(e,t,n){"use strict";function o(e){return e&&"[object Function]"==y.call(e)}function r(e){return function(t,n,o){h.get(e+"/userinfo").set("Authorization","Bearer "+t.body.access_token).end(function(e,r){return e?void n.redirect(n.locals.baseUrl):(t.userInfo=r.body,void o())})}}function a(e,t){return function(n,r,a){var i=e;o(e)&&(i=e(n)),n.apiToken=p.sign(n.userInfo,i,{algorithm:"HS256",issuer:r.locals.baseUrl,expiresIn:t}),delete n.userinfo,a()}}function i(e,t){var n=["html","  head","    script.","      window.location.href = '#{returnTo}';","  body"].join("\n"),o=u.compile(n)({returnTo:e.query&&e.query.returnTo?e.query.returnTo:t.locals.baseUrl});return o}var s=n(2),u=n(22),c=n(20),l=n(25),d=n(17),f=n(6),p=n(3),h=n(24),y={}.toString;e.exports=function(e){var t=864e5,o=s.Router(),h=function(e,t,n){n()},y=[h];return e=e||{},e.clientName=e.clientName||"Auth0 Extension",e.clientId=e.clientId,e.exp=e.exp||t,e.experimental=e.experimental||!1,e.credentialsRequired="undefined"!=typeof e.credentialsRequired&&e.credentialsRequired,e.scopes=e.scopes+" openid profile",e.responseType=e.responseType||"token",e.tokenExpiresIn=e.tokenExpiresIn||"10h",e.rootTenantAuthority=e.rootTenantAuthority||"https://auth0.auth0.com",e.authenticatedCallback=e.authenticatedCallback||function(e,t,n,o){o()},e.apiToken&&!e.apiToken.secret&&(console.log('You are using a "development secret" for API token generation. Please setup your secret on "apiToken.secret".'),e.apiToken.secret=n(19).randomBytes(32).toString("hex")),e.apiToken&&e.apiToken.secret&&(y=[r(e.rootTenantAuthority),e.apiToken.payload||h,a(e.apiToken.secret,e.tokenExpiresIn)]),o.use(function(t,n,o){var r="https",a=l.parse(t.originalUrl).pathname.replace(t.path,"");"development"===(process.env.NODE_ENV||"development")&&(r=t.protocol,e.clientId=e.clientId||"N3PAwyqXomhNu6IWivtsa3drBfFjmWJL"),n.locals.baseUrl=l.format({protocol:r,host:t.get("host"),pathname:a}),o()}),o.use(f.urlencoded({extended:!1})),o.use(c({secret:d(),algorithms:["RS256"],credentialsRequired:e.credentialsRequired}).unless({path:["/login","/callback"]})),o.get("/login",function(t,n){var o=n.locals.baseUrl+"/callback";t.query.returnTo&&(o+="?returnTo="+encodeURIComponent(t.query.returnTo));var r;if("string"==typeof e.audience)r="&audience="+encodeURIComponent(e.audience);else if("function"==typeof e.audience){var a=e.audience(t);"string"==typeof a&&(r="&audience="+encodeURIComponent(a))}var i=[e.rootTenantAuthority+(e.experimental?"/authorize":"/i/oauth2/authorize"),"?client_id="+(e.clientId||n.locals.baseUrl),"&response_type="+e.responseType,"&response_mode=form_post","&scope="+encodeURIComponent(e.scopes),"&expiration="+e.exp,"&redirect_uri="+o,r].join("");n.redirect(i)}),o.get("/logout",function(t,n){var o=["html","  head","    script.","      sessionStorage.removeItem('token')","      sessionStorage.removeItem('apiToken')","      window.location.href = '"+e.rootTenantAuthority+"/v2/logout?returnTo=#{baseUrl}&client_id=#{baseUrl}';","  body"].join("\n"),r=u.compile(o)({baseUrl:n.locals.baseUrl});n.header("Content-Type","text/html"),n.status(200).send(r)}),o.post("/callback",y,function(t,n){var o=t.body.access_token,r=p.decode(o,{complete:!0})||{};d()(t,r.header,r.payload,function(r,a){if(r)return n.status(200).send(i(n,n));try{var s,c=p.verify(o,a,{algorithms:["RS256"]}),l=c.aud;if("string"==typeof e.audience)s=e.audience;else if("function"==typeof e.audience){var d=e.audience(t);"string"==typeof d&&(s=d)}if(l===s||l.indexOf(s)===-1)return n.header("Content-Type","text/html"),n.status(200).send(i(t,n))}catch(e){return n.status(200).send(i(n,n))}e.authenticatedCallback(t,n,t.body.access_token,function(e){if(e)return n.sendStatus(500);var o=["html","  head","    script.","      sessionStorage.setItem('token', '"+t.body.access_token+"');",1===y.length?"":"      sessionStorage.setItem('apiToken', '"+t.apiToken+"');","      window.location.href = '#{returnTo}';","  body"].join("\n"),r=u.compile(o)({returnTo:t.query.returnTo?t.query.returnTo:n.locals.baseUrl});n.header("Content-Type","text/html"),n.status(200).send(r)})})}),o.get("/.well-known/oauth2-client-configuration",function(t,n){n.header("Content-Type","application/json"),n.status(200).send({redirect_uris:[n.locals.baseUrl+"/callback"],client_name:e.clientName,post_logout_redirect_uris:[n.locals.baseUrl]})}),o}},function(e,t,n){"use strict";function o(e){return null!=e&&""!==e}function r(e){return(Array.isArray(e)?e.map(r):e&&"object"===("undefined"==typeof e?"undefined":a(e))?Object.keys(e).filter(function(t){return e[t]}):[e]).filter(o).join(" ")}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.merge=function e(t,n){if(1===arguments.length){for(var r=t[0],a=1;a<t.length;a++)r=e(r,t[a]);return r}var i=t.class,s=n.class;(i||s)&&(i=i||[],s=s||[],Array.isArray(i)||(i=[i]),Array.isArray(s)||(s=[s]),t.class=i.concat(s).filter(o));for(var u in n)"class"!=u&&(t[u]=n[u]);return t},t.joinClasses=r,t.cls=function(e,n){for(var o=[],a=0;a<e.length;a++)n&&n[a]?o.push(t.escape(r([e[a]]))):o.push(r(e[a]));var i=r(o);return i.length?' class="'+i+'"':""},t.style=function(e){return e&&"object"===("undefined"==typeof e?"undefined":a(e))?Object.keys(e).map(function(t){return t+":"+e[t]}).join(";"):e},t.attr=function(e,n,o,r){return"style"===e&&(n=t.style(n)),"boolean"==typeof n||null==n?n?" "+(r?e:e+'="'+e+'"'):"":0==e.indexOf("data")&&"string"!=typeof n?(JSON.stringify(n).indexOf("&")!==-1&&console.warn("Since Jade 2.0.0, ampersands (`&`) in data attributes will be escaped to `&amp;`"),n&&"function"==typeof n.toISOString&&console.warn("Jade will eliminate the double quotes around dates in ISO form after 2.0.0")," "+e+"='"+JSON.stringify(n).replace(/'/g,"&apos;")+"'"):o?(n&&"function"==typeof n.toISOString&&console.warn("Jade will stringify dates in ISO form after 2.0.0")," "+e+'="'+t.escape(n)+'"'):(n&&"function"==typeof n.toISOString&&console.warn("Jade will stringify dates in ISO form after 2.0.0")," "+e+'="'+n+'"')},t.attrs=function(e,n){var o=[],a=Object.keys(e);if(a.length)for(var i=0;i<a.length;++i){var s=a[i],u=e[s];"class"==s?(u=r(u))&&o.push(" "+s+'="'+u+'"'):o.push(t.attr(s,u,!1,n))}return o.join("")},t.escape=function(e){var t=String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");return t===""+e?e:t},t.rethrow=function e(t,o,r,a){if(!(t instanceof Error))throw t;if(!("undefined"==typeof window&&o||a))throw t.message+=" on line "+r,t;try{a=a||n(21).readFileSync(o,"utf8")}catch(n){e(t,null,r)}var i=3,s=a.split("\n"),u=Math.max(r-i,0),c=Math.min(s.length,r+i),i=s.slice(u,c).map(function(e,t){var n=t+u+1;return(n==r?"  > ":"    ")+n+"| "+e}).join("\n");throw t.path=o,t.message=(o||"Jade")+":"+r+"\n"+i+"\n\n"+t.message,t},t.DebugItem=function(e,t){this.lineno=e,this.filename=t}},function(e,t){"use strict";e.exports={title:"Captcha Extension",name:"captcha-extension",version:"0.1.0",author:"abhishek.hingikar@auth0.com",description:"An extension that uses Google's ReCaptcha",type:"application",keywords:["auth0"],auth0:{createClient:!0,scopes:"create:rules read:rules delete:rules",onInstallPath:"/.extensions/on-install",onUninstallPath:"/.extensions/on-uninstall",onUpdatePath:"/.extensions/on-update"}}},function(e,t,n){"use strict";function o(e){return function(t,n,o){var r=i(n.x_wt.jtn);return n.originalUrl=n.url,n.url=n.url.replace(r,"/"),n.webtaskContext=s(t),e(n,o)}}function r(e){var t;return e.ext("onRequest",function(e,n){var o=i(e.x_wt.jtn);e.setUrl(e.url.replace(o,"/")),e.webtaskContext=t}),function(n,o,r){var a=e._dispatch();t=s(n),a(o,r)}}function a(e){return function(t,n,o){var r=i(n.x_wt.jtn);return n.originalUrl=n.url,n.url=n.url.replace(r,"/"),n.webtaskContext=s(t),e.emit("request",n,o)}}function i(e){var t="^/api/run/[^/]+/",n="(?:[^/?#]*/?)?";return new RegExp(t+(e?n:""))}function s(e){function t(e,t,o){var r=n(1);"function"==typeof t&&(o=t,t={}),o(r.preconditionFailed("Storage is not available in this context"))}function o(t,o,r){var a=n(1),i=n(4);"function"==typeof o&&(r=o,o={}),i({uri:e.secrets.EXT_STORAGE_URL,method:"GET",headers:o.headers||{},qs:{path:t},json:!0},function(e,t,n){return e?r(a.wrap(e,502)):404===t.statusCode&&Object.hasOwnProperty.call(o,"defaultValue")?r(null,o.defaultValue):t.statusCode>=400?r(a.create(t.statusCode,n&&n.message)):void r(null,n)})}function r(e,t,o,r){var a=n(1);"function"==typeof o&&(r=o,o={}),r(a.preconditionFailed("Storage is not available in this context"))}function a(t,o,r,a){var i=n(1),s=n(4);"function"==typeof r&&(a=r,r={}),s({uri:e.secrets.EXT_STORAGE_URL,method:"PUT",headers:r.headers||{},qs:{path:t},body:o},function(e,t,n){return e?a(i.wrap(e,502)):t.statusCode>=400?a(i.create(t.statusCode,n&&n.message)):void a(null)})}return e.read=e.secrets.EXT_STORAGE_URL?o:t,e.write=e.secrets.EXT_STORAGE_URL?a:r,e}t.fromConnect=t.fromExpress=o,t.fromHapi=r,t.fromServer=t.fromRestify=a},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),a=o(r),i=n(3),s=o(i),u=n(5),c=o(u),l=n(16),d=o(l),f=n(6),p=o(f),h=n(23),y=(o(h),n(10)),m=o(y),g=n(9),v=o(g),b=a.default.Router();b.use(function(e,t,n){var o=e.query.token||e.body.token,r=e.query.state||e.body.state,a=e.webtaskContext.data,i=a.EXTENSION_SECRET,u=a.AUTH0_DOMAIN,l=(0,c.default)(u,"captcha/rule"),d=(0,c.default)(u,"captcha/webtask");s.default.verify(o,i,{issuer:l,audience:d},function(a,s){return a?(0,v.default)("Invalid token: "+a.message,i,null,l,d).then(function(n){t.redirect(e.webtaskContext.data.AUTH0_DOMAIN+"/continue?state="+e.query.state+"&token="+n)}):(e.state=r,e.token=o,e.payload=s,void n())})}),b.use(p.default.urlencoded()),b.get("/",function(e,t){t.header("Content-Type","text/html"),t.status(200).send((0,d.default)(Object.assign({token:e.token,target:e.path},e.payload)))}),b.post("/",function(e,t){var n=e.ip,o=n.ip,r=n.state,a=n.payload,i=e.webtaskContext.data,s=i.EXTENSION_SECRET,u=i.AUTH0_DOMAIN,l=e.body["g-recaptcha-response"],d=(0,c.default)(u,"captcha/rule"),f=(0,c.default)(u,"captcha/webtask");(0,m.default)(l,s,o).then(function(){return(0,v.default)(null,secret,a,d,f)},function(e){return(0,v.default)(e.message,secret,a,d,f)}).then(function(e){t.redirect(u+"/continue?state="+r+"&token="+e)})}),t.default=b},function(e,t,n){var o=n(12);e.exports=function(e){var t=[],n=e||{};return function(e,n,r,a){t.push('<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><style type="text/css">html {\nfont-family: sans-serif;\n-webkit-text-size-adjust: 100%;\n-ms-text-size-adjust: 100%;\n}\nbody { margin: 0; }\n.container { padding-right: 15px; padding-left: 15px;margin-right: auto; margin-left: auto; }\nh1 { margin: .67em 0; font-size: 2em; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; }</style><title>Confirm you are human</title><!-- Latest compiled and minified CSS--><script src="https://www.google.com/recaptcha/api.js"></script></head><body><script type="text/javascript">var submitform = function() {\n  document.getElementById("captchaform").submit();\n};</script><div class="container"><form id="captchaform"'+o.attr("action",r,!0,!0)+' method="POST" class="form-signin"><h1>title</h1><p>message</p><input type="hidden"'+o.attr("value",n,!0,!0)+' name="state"><input type="hidden"'+o.attr("value",a,!0,!0)+' name="token"><div'+o.attr("data-sitekey",e,!0,!0)+' data-callback="submitform" class="g-recaptcha"></div></form></div></body></html>')}.call(this,"siteKey"in n?n.siteKey:"undefined"!=typeof siteKey?siteKey:void 0,"state"in n?n.state:"undefined"!=typeof state?state:void 0,"target"in n?n.target:"undefined"!=typeof target?target:void 0,"token"in n?n.token:"undefined"!=typeof token?token:void 0),t.join("")}},function(e,t){e.exports=require("auth0-api-jwt-rsa-validation")},function(e,t){e.exports=require("auth0@2.1.0")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("express-jwt")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("jade")},function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("superagent")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require(void 0)}]);